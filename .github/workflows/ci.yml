name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # ðŸ‘‡ Ð Ð•Ð¨Ð•ÐÐ˜Ð•: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ TCP Ð¼Ð¾ÑÑ‚ Ðº Ð”Ð¾ÐºÐµÑ€Ñƒ
      - name: Setup Docker TCP Bridge
        run: |
          # 1. Ð¡Ñ‚Ð°Ð²Ð¸Ð¼ socat (ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð±Ñ€Ð¾ÑÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²)
          sudo apt-get update && sudo apt-get install -y socat
          
          # 2. ÐŸÑ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Unix-ÑÐ¾ÐºÐµÑ‚ Ð² TCP Ð¿Ð¾Ñ€Ñ‚ 2375
          # fork = Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¼Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹
          # bind = ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
          sudo socat TCP-LISTEN:2375,fork,bind=127.0.0.1 UNIX-CONNECT:/var/run/docker.sock &
          
          # 3. Ð–Ð´ÐµÐ¼ Ð¿Ð°Ñ€Ñƒ ÑÐµÐºÑƒÐ½Ð´, Ð¿Ð¾ÐºÐ° Ð¿Ð¾Ð´Ð½Ð¸Ð¼ÐµÑ‚ÑÑ
          sleep 5
          
          # 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ€Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
          nc -zv 127.0.0.1 2375

      - name: Build and Test
        # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð¿Ð¾ TCP. Ð­Ñ‚Ð¾ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» ÑÐ¾ÐºÐµÑ‚Ð° Ð³Ð»ÑŽÑ‡Ð¸Ñ‚.
        run: >
          mvn -B verify
          -Ddocker.host=tcp://127.0.0.1:2375
          -Dtestcontainers.ryuk.disabled=true
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Login to DockerHub
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker image
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            danil0ss/user-service:latest
            danil0ss/user-service:${{ github.sha }}